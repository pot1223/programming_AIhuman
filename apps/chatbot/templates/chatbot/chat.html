{% extends "chatbot/base.html" %}

{% block content %}
<div class="main-container-split">

    <div class="chat-panel" id="chat-panel">
        <div class="chat-header">AI 챗봇</div>
        <div class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="메시지를 입력하세요...">
            <button id="send-btn">▶</button>
        </div>
    </div>

    <div class="resizer" id="resizer-drag-handle"></div>

    <div class="code-panel" id="code-panel">
        <div class="code-header">
            <span>코드 뷰어</span>
            <button id="clear-code-btn">초기화</button>
        </div>
        <div class="code-content">
            <div class="placeholder">AI가 생성한 코드가 여기에 표시됩니다.</div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

        const sendBtn = document.getElementById('send-btn');
        const chatInput = document.getElementById('chat-input');
        const messagesContainer = document.querySelector('.chat-messages');
        const codeContainer = document.querySelector('.code-content');
        const clearCodeBtn = document.getElementById('clear-code-btn');
        const codePlaceholder = document.querySelector('.code-content .placeholder');
        let chatHistory = [];

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function addMessageToScreen(role, content = '') {
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '15px';
            const prefix = `<strong>${role === 'user' ? '나' : '챗봇'}:</strong><br>`;
            
            if (role === 'user') {
                messageDiv.innerHTML = prefix + escapeHtml(content).replace(/\n/g, '<br>');
            } else {
                messageDiv.innerHTML = prefix;
            }
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }

        function renderCodeBlock(codeContent) {
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/;
            const match = codeBlockRegex.exec(codeContent);
            if (!match) return;
            const language = match[1] || 'plaintext';
            const code = match[2];
            const container = document.createElement('div');
            container.className = 'code-block-container';
            const header = document.createElement('div');
            header.className = 'code-block-header';
            const langSpan = document.createElement('span');
            langSpan.textContent = language;
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = '복사';
            header.appendChild(langSpan);
            header.appendChild(copyBtn);
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.className = `language-${escapeHtml(language)}`;
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            container.appendChild(header);
            container.appendChild(pre);

            // Placeholder가 있다면 찾아서 삭제 (display:none 대신)
            const existingPlaceholder = codeContainer.querySelector('.placeholder');
            if (existingPlaceholder) {
                existingPlaceholder.remove();
            }

            codeContainer.appendChild(container);
            codeContainer.scrollTop = codeContainer.scrollHeight;
            hljs.highlightElement(codeEl);
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.textContent = '복사 완료!';
                    copyBtn.classList.add('copied');
                    setTimeout(() => {
                        copyBtn.textContent = '복사';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                });
            });
        }

        async function sendMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            const isCodeViewerEmpty = codeContainer.querySelector('.placeholder');
            if (isCodeViewerEmpty) {
                isCodeViewerEmpty.textContent = 'AI 응답을 기다리는 중...';
            }

            addMessageToScreen('user', messageText);
            chatHistory.push({ "role": "user", "content": messageText });
            chatInput.value = '';
            chatInput.focus();

            const botMessageDiv = addMessageToScreen('assistant');
            let fullBotResponseForHistory = '';
            let waitingMessageCleared = false;
            const CLEAR_SIGNAL = "<!--CLEAR-->";
            let codeRendered = false;

            let currentTextSpan = document.createElement('span');
            botMessageDiv.appendChild(currentTextSpan);

            try {
                const response = await fetch("{{ url_for('program_chat.process_chat') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "message": messageText, "history": chatHistory.slice(0, -1) }),
                });

                if (!response.ok) throw new Error('서버 응답 오류');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    let chunk = decoder.decode(value, { stream: true });
                    
                    if (!waitingMessageCleared) {
                        if (chunk.includes(CLEAR_SIGNAL)) {
                            currentTextSpan.innerHTML = '';
                            waitingMessageCleared = true;
                            chunk = chunk.split(CLEAR_SIGNAL)[1] || '';
                        } else {
                            currentTextSpan.innerHTML = escapeHtml(chunk);
                            continue;
                        }
                    }

                    if (!chunk) continue;

                    fullBotResponseForHistory += chunk;
                    if (chunk.trim().startsWith('```') && chunk.trim().endsWith('```')) {
                        // 코드 뷰어 내용이 자동으로 삭제되지 않도록 수정
                        renderCodeBlock(chunk);
                        codeRendered = true;
                        
                        currentTextSpan.innerHTML = currentTextSpan.innerHTML.replace(/(<br\s*\/?>\s*)+$/, '');
                        const placeholderText = '[코드가 코드 뷰어에 표시되었습니다.]';
                        const placeholderHtml = `<div style="margin: 0.5rem 0; font-style: italic; color: #888;">${escapeHtml(placeholderText)}</div>`;
                        currentTextSpan.innerHTML += placeholderHtml;

                    } else {
                        currentTextSpan.innerHTML += escapeHtml(chunk).replace(/\n/g, '<br>');
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
                chatHistory.push({ "role": "assistant", "content": fullBotResponseForHistory });

                if (!codeRendered && isCodeViewerEmpty) {
                    isCodeViewerEmpty.textContent = '이번 답변에는 코드가 포함되어 있지 않습니다.';
                }

            } catch (error) {
                console.error('Error:', error);
                if(!waitingMessageCleared) currentTextSpan.innerHTML = '';
                currentTextSpan.innerHTML += '<br><strong style="color: red;">오류가 발생했습니다.</strong>';
                if (isCodeViewerEmpty) {
                    isCodeViewerEmpty.textContent = '오류가 발생했습니다.';
                }
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (event) => {
            if (event.isComposing) return;
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });

        clearCodeBtn.addEventListener('click', () => {
            codeContainer.innerHTML = '';
            const newPlaceholder = document.createElement('div');
            newPlaceholder.className = 'placeholder';
            newPlaceholder.textContent = 'AI가 생성한 코드가 여기에 표시됩니다.';
            codeContainer.appendChild(newPlaceholder);
        });
        
        window.addEventListener('beforeunload', function(event) {
            const logoutUrl = "{{ url_for('program_chat.track_logout') }}";
            // navigator.sendBeacon을 사용하여 브라우저가 비동기적으로 데이터를 전송하도록 합니다.
            // 이 방식은 페이지가 닫히는 중에도 요청이 취소되지 않도록 보장합니다.
            navigator.sendBeacon(logoutUrl);
        });

        const resizer = document.getElementById('resizer-drag-handle');
        const leftPanel = document.getElementById('chat-panel');
        const rightPanel = document.getElementById('code-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.userSelect = 'none';
            document.body.style.pointerEvents = 'none';
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const container = resizer.parentElement;
            const containerRect = container.getBoundingClientRect();
            let leftPanelWidth = e.clientX - containerRect.left;
            const minWidth = 300;
            if (leftPanelWidth < minWidth) leftPanelWidth = minWidth;
            if (leftPanelWidth > containerRect.width - minWidth) leftPanelWidth = containerRect.width - minWidth;
            const leftFlex = leftPanelWidth / containerRect.width;
            leftPanel.style.flex = leftFlex.toString();
            rightPanel.style.flex = (1 - leftFlex).toString();
        }

        function handleMouseUp() {
            isResizing = false;
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
            document.body.style.userSelect = 'auto';
            document.body.style.pointerEvents = 'auto';
        }
    });
</script>
{% endblock %}